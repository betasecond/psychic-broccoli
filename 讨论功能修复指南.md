# 讨论功能修复指南

## 快速修复步骤

### 步骤 1: 备份当前文件

```bash
cd /e/biyesheji/psychic-broccoli

# 备份前端文件
cp frontend/src/services/discussionService.ts frontend/src/services/discussionService.ts.backup

# 备份后端文件
cp backend/handlers/discussions.go backend/handlers/discussions.go.backup
```

### 步骤 2: 修复前端类型定义

**文件**: `frontend/src/services/discussionService.ts`

**修改第 6 行**:
```typescript
// 原代码
replies: number

// 修改为
replyCount: number
```

**修改第 33-35 行**:
```typescript
// 保持不变，现在没有冲突了
export interface DiscussionDetail extends Discussion {
  replies: DiscussionReply[]
}
```

或者直接替换整个文件：
```bash
mv discussionService.ts.fixed frontend/src/services/discussionService.ts
```

### 步骤 3: 修复后端 API 响应

**文件**: `backend/handlers/discussions.go`

#### 3.1 修复 GetDiscussions 函数（第 152-158 行）

```go
// 原代码
discussionData := map[string]interface{}{
    "id":        d.ID,
    "title":     d.Title,
    "status":    d.Status,
    "replies":   d.Replies,  // ❌ 旧代码
    "createdAt": d.CreatedAt.Format(time.RFC3339),
}

// 修改为
discussionData := map[string]interface{}{
    "id":        d.ID,
    "title":     d.Title,
    "status":    d.Status,
    "replyCount": d.Replies,  // ✅ 新代码
    "createdAt": d.CreatedAt.Format(time.RFC3339),
}
```

#### 3.2 修复 GetDiscussionDetail 函数（第 229-235 行）

```go
// 原代码
discussionData := map[string]interface{}{
    "id":        d.ID,
    "title":     d.Title,
    "status":    d.Status,
    "replies":   d.Replies,  // ❌ 旧代码
    "createdAt": d.CreatedAt.Format(time.RFC3339),
}

// 修改为
discussionData := map[string]interface{}{
    "id":        d.ID,
    "title":     d.Title,
    "status":    d.Status,
    "replyCount": d.Replies,  // ✅ 新代码
    "createdAt": d.CreatedAt.Format(time.RFC3339),
}
```

### 步骤 4: 更新前端页面代码

需要检查以下文件，将所有使用 `replies` 作为数字的地方改为 `replyCount`:

**文件**: `frontend/src/pages/student/DiscussionsPage.tsx`

查找并替换：
```tsx
// 查找类似这样的代码
{discussion.replies} 条回复

// 改为
{discussion.replyCount} 条回复
```

**文件**: `frontend/src/pages/student/DiscussionDetailPage.tsx`

保持不变，因为详情页面使用 `replies` 数组是正确的。

### 步骤 5: 重新编译和测试

```bash
# 重新编译 Go 后端
cd backend
go build -o server-linux

# 重新编译前端（如果需要）
cd ../frontend
npm run build

# 重启后端服务器
cd ../backend
./server-linux
```

### 步骤 6: 验证修复

1. **测试创建讨论**:
   ```bash
   curl -X POST http://localhost:8080/api/v1/discussions \
     -H "Authorization: Bearer YOUR_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{
       "courseId": 1,
       "title": "测试讨论",
       "content": "这是测试内容"
     }'
   ```

2. **测试获取讨论列表**:
   ```bash
   curl http://localhost:8080/api/v1/discussions?courseId=1 \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

   验证响应中包含 `replyCount` 字段而不是 `replies` 数字。

3. **测试获取讨论详情**:
   ```bash
   curl http://localhost:8080/api/v1/discussions/1 \
     -H "Authorization: Bearer YOUR_TOKEN"
   ```

   验证响应中同时包含 `replyCount`（数字）和 `replies`（数组）。

---

## 完整的修复代码片段

### discussions.go 需要修改的部分

#### 修改 1: GetDiscussions (第 152-158 行)

```go
discussionData := map[string]interface{}{
	"id":        d.ID,
	"title":     d.Title,
	"status":    d.Status,
	"replyCount": d.Replies,
	"createdAt": d.CreatedAt.Format(time.RFC3339),
}
```

#### 修改 2: GetDiscussionDetail (第 229-235 行)

```go
discussionData := map[string]interface{}{
	"id":        d.ID,
	"title":     d.Title,
	"status":    d.Status,
	"replyCount": d.Replies,
	"createdAt": d.CreatedAt.Format(time.RFC3339),
}
```

---

## 可选的增强修复

### 添加错误处理

在第 51-54 行添加错误处理：

```go
// 原代码
database.DB.QueryRow(
	"SELECT COUNT(*) FROM course_enrollments WHERE course_id = ? AND student_id = ?",
	req.CourseID, userID,
).Scan(&enrolled)

// 改进后
err = database.DB.QueryRow(
	"SELECT COUNT(*) FROM course_enrollments WHERE course_id = ? AND student_id = ?",
	req.CourseID, userID,
).Scan(&enrolled)

if err != nil {
	c.JSON(500, gin.H{"error": "验证选课状态失败"})
	return
}
```

### 添加输入验证

在 CreateDiscussion 函数开头添加：

```go
// 验证标题和内容长度
if len(req.Title) > 200 {
	c.JSON(400, gin.H{"error": "标题不能超过200字符"})
	return
}

if len(req.Content) > 10000 {
	c.JSON(400, gin.H{"error": "内容不能超过10000字符"})
	return
}
```

---

## 测试清单

- [ ] 创建讨论成功
- [ ] 讨论列表显示正确的回复数量
- [ ] 讨论详情显示回复列表
- [ ] 回复讨论后回复数量更新
- [ ] 关闭讨论功能正常
- [ ] 删除讨论功能正常
- [ ] TypeScript 类型检查通过（无类型错误）

---

最后更新：2026-02-08
