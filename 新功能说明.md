# 🎉 新功能说明

## 如何更新后端

在项目根目录运行：

```powershell
.\update-backend.ps1
```

这个脚本会自动：
1. ✅ 停止旧的服务器
2. ✅ 安装Excel处理库
3. ✅ 重新编译
4. ✅ 启动新服务器

## ✨ 新增功能列表

### 1️⃣ 作业管理 - 完整CRUD

| 操作 | 方法 | 端点 | 权限 |
|------|------|------|------|
| 创建 | POST | `/api/v1/assignments` | 教师/管理员 |
| 读取列表 | GET | `/api/v1/assignments` | 认证用户 |
| 读取详情 | GET | `/api/v1/assignments/:id` | 认证用户 |
| **更新** | **PUT** | **`/api/v1/assignments/:id`** | **教师/管理员** |
| **删除** | **DELETE** | **`/api/v1/assignments/:id`** | **教师/管理员** |

### 2️⃣ 考试管理 - 完整CRUD

| 操作 | 方法 | 端点 | 权限 |
|------|------|------|------|
| 创建考试 | POST | `/api/v1/exams` | 教师/管理员 |
| 读取考试列表 | GET | `/api/v1/exams` | 认证用户 |
| 读取考试详情 | GET | `/api/v1/exams/:id` | 认证用户 |
| **更新考试** | **PUT** | **`/api/v1/exams/:id`** | **教师/管理员** |
| **删除考试** | **DELETE** | **`/api/v1/exams/:id`** | **教师/管理员** |
| 添加题目 | POST | `/api/v1/exams/:id/questions` | 教师/管理员 |
| **更新题目** | **PUT** | **`/api/v1/exams/:id/questions/:qid`** | **教师/管理员** |
| **删除题目** | **DELETE** | **`/api/v1/exams/:id/questions/:qid`** | **教师/管理员** |

### 3️⃣ 章节管理 - 完整CRUD

| 操作 | 方法 | 端点 | 权限 |
|------|------|------|------|
| 创建章节 | POST | `/api/v1/courses/:id/chapters` | 教师/管理员 |
| 读取章节列表 | GET | `/api/v1/courses/:id/chapters` | 所有用户 |
| **更新章节** | **PUT** | **`/api/v1/courses/:id/chapters/:cid`** | **教师/管理员** |
| **删除章节** | **DELETE** | **`/api/v1/courses/:id/chapters/:cid`** | **教师/管理员** |

### 4️⃣ 用户批量导入（Excel）⭐ 全新功能

| 操作 | 方法 | 端点 | 权限 |
|------|------|------|------|
| **批量导入用户** | **POST** | **`/api/v1/auth/import-users`** | **管理员** |
| **下载导入模板** | **GET** | **`/api/v1/auth/user-template`** | **管理员** |

## 📥 Excel批量导入用户使用指南

### 步骤1: 下载模板

**方法A - 浏览器下载**：
1. 以管理员身份登录系统
2. 访问：`http://localhost:8080/api/v1/auth/user-template`
3. 自动下载 `user_import_template.xlsx`

**方法B - 前端代码调用**：
```typescript
import { userService } from '@/services/userService'

// 下载模板
await userService.triggerDownloadTemplate()
```

### 步骤2: 填写Excel表格

模板包含以下列：

| 列名 | 必填 | 说明 | 示例 |
|------|------|------|------|
| 用户名 | ✅ | 唯一，不能重复 | student01 |
| 密码 | ✅ | 明文密码，系统会自动加密 | password123 |
| 角色 | ✅ | STUDENT/INSTRUCTOR/ADMIN | STUDENT |
| 邮箱 | ❌ | 可选 | student01@example.com |
| 头像URL | ❌ | 可选 | https://i.pravatar.cc/150?u=student01 |

**示例数据**：
```
用户名      密码          角色         邮箱                    头像URL
student01   password123   STUDENT      student01@example.com   https://...
teacher01   password123   INSTRUCTOR   teacher01@example.com   https://...
admin01     password123   ADMIN        admin01@example.com     https://...
```

### 步骤3: 上传Excel文件

**前端代码示例**：
```typescript
import { userService } from '@/services/userService'

// 处理文件上传
const handleFileUpload = async (file: File) => {
  try {
    const result = await userService.importUsersFromExcel(file)
    console.log('导入结果:', result)
    // {
    //   successCount: 10,
    //   errorCount: 2,
    //   errors: ["第3行: 用户名已存在", ...],
    //   message: "成功导入10个用户，失败2个"
    // }
  } catch (error) {
    console.error('导入失败:', error)
  }
}

// 在Ant Design Upload组件中使用
<Upload
  beforeUpload={(file) => {
    handleFileUpload(file)
    return false // 阻止自动上传
  }}
  accept=".xlsx,.xls"
>
  <Button icon={<UploadOutlined />}>批量导入用户</Button>
</Upload>
```

### 步骤4: 查看导入结果

系统会返回：
- `successCount`: 成功导入的用户数
- `errorCount`: 失败的记录数
- `errors`: 失败原因列表（包含行号）
- `message`: 汇总信息

## 🧪 测试新功能

运行测试脚本：

```powershell
cd backend
.\test-new-features.ps1
```

这会测试：
- ✅ 更新作业
- ✅ 更新考试
- ✅ 更新章节
- ✅ 下载导入模板提示

## 📝 前端集成示例

### 导入userService

```typescript
import { userService } from '@/services/userService'
```

### 下载模板

```typescript
const handleDownloadTemplate = async () => {
  try {
    await userService.triggerDownloadTemplate()
    message.success('模板下载成功')
  } catch (error) {
    message.error('模板下载失败')
  }
}
```

### 批量导入

```typescript
const handleImport = async (file: File) => {
  try {
    const result = await userService.importUsersFromExcel(file)
    
    if (result.errorCount > 0) {
      // 显示错误详情
      Modal.warning({
        title: `导入完成（成功${result.successCount}个，失败${result.errorCount}个）`,
        content: (
          <div>
            {result.errors.map((err, index) => (
              <div key={index}>{err}</div>
            ))}
          </div>
        ),
      })
    } else {
      message.success(result.message)
    }
  } catch (error) {
    message.error('导入失败')
  }
}
```

### 完整组件示例

```typescript
import { Upload, Button, Modal, message } from 'antd'
import { UploadOutlined, DownloadOutlined } from '@ant-design/icons'
import { userService } from '@/services/userService'

const UserImportPage = () => {
  const handleDownloadTemplate = async () => {
    await userService.triggerDownloadTemplate()
    message.success('模板下载成功')
  }

  const handleFileUpload = async (file: File) => {
    const result = await userService.importUsersFromExcel(file)
    
    if (result.errorCount > 0) {
      Modal.warning({
        title: `导入结果`,
        content: (
          <div>
            <p>成功: {result.successCount} 个</p>
            <p>失败: {result.errorCount} 个</p>
            <div style={{ maxHeight: 200, overflow: 'auto' }}>
              {result.errors.map((err, i) => <div key={i}>{err}</div>)}
            </div>
          </div>
        ),
      })
    } else {
      message.success(result.message)
    }
  }

  return (
    <div>
      <Button 
        icon={<DownloadOutlined />} 
        onClick={handleDownloadTemplate}
        style={{ marginRight: 16 }}
      >
        下载导入模板
      </Button>
      
      <Upload
        beforeUpload={(file) => {
          handleFileUpload(file)
          return false
        }}
        accept=".xlsx,.xls"
        showUploadList={false}
      >
        <Button icon={<UploadOutlined />}>
          批量导入用户
        </Button>
      </Upload>
    </div>
  )
}
```

## 🎯 CRUD功能对比

### 更新前 ❌
- 作业：只能创建、查看，**不能修改、删除**
- 考试：只能创建、查看，**不能修改、删除**
- 题目：只能添加，**不能修改、删除**
- 章节：只能创建、查看，**不能修改、删除**
- 用户：**只能单个注册**

### 更新后 ✅
- 作业：✅ 完整CRUD（创建、读取、更新、删除）
- 考试：✅ 完整CRUD
- 题目：✅ 完整CRUD
- 章节：✅ 完整CRUD
- 用户：✅ 支持Excel批量导入

## 📚 API文档更新

完整的API文档请查看 `backend/使用说明.md`

新增端点已自动集成到后端，无需额外配置！

## 🚀 开始使用

1. **更新后端**：
   ```powershell
   .\update-backend.ps1
   ```

2. **测试功能**：
   ```powershell
   cd backend
   .\test-new-features.ps1
   ```

3. **前端集成**：
   使用 `frontend/src/services/userService.ts` 调用新API

祝使用愉快！🎉

