# ============================================================
# Docker Compose - Production Configuration
# CourseArk: Go (Gin) backend + React (Vite) frontend + Watchtower
# ============================================================
# Usage:
#   1. Create .env file with REQUIRED variables:
#      - GHCR_OWNER (required): Your GitHub username
#      - JWT_SECRET (required): Strong random string for JWT signing
#   2. docker compose -f docker-compose.prod.yml up -d
#
# .env.example:
#   GHCR_OWNER=your-github-username    # REQUIRED
#   JWT_SECRET=your-super-secret-key   # REQUIRED
#   WEB_PORT=80
#   ENABLE_SEED=false
# ============================================================

services:
  # ==========================================================
  # Backend API - Go (Gin) + SQLite
  # ==========================================================
  backend:
    image: "ghcr.io/${GHCR_OWNER:?GHCR_OWNER is required}/psychic-broccoli-backend:latest"
    container_name: courseark-backend
    restart: unless-stopped
    environment:
      - SERVER_PORT=8080
      - DB_PATH=/data/education.db
      - "JWT_SECRET=${JWT_SECRET:?JWT_SECRET is required}"
      - GIN_MODE=release
      - ENABLE_SEED=${ENABLE_SEED:-false}
    volumes:
      # Persist SQLite database
      - sqlite_data:/data
      # Persist uploaded files (attachments, etc.)
      - uploads_data:/app/public/uploads
    networks:
      - courseark-network
    labels:
      # Enable watchtower auto-update for this service
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      start_period: 10s
      retries: 3

  # ==========================================================
  # Web Frontend - Nginx serving React + reverse proxy to API
  # ==========================================================
  web:
    image: "ghcr.io/${GHCR_OWNER:?GHCR_OWNER is required}/psychic-broccoli-web:latest"
    container_name: courseark-web
    restart: unless-stopped
    # Ports are now handled by Caddy reverse proxy
    # ports:
    #   - "${WEB_PORT:-80}:80"
    networks:
      - courseark-network
    depends_on:
      backend:
        condition: service_healthy
    labels:
      # Enable watchtower auto-update for this service
      - "com.centurylinklabs.watchtower.enable=true"
    healthcheck:
      # Use 127.0.0.1 instead of localhost to avoid IPv6 resolution issues
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://127.0.0.1:80/"]
      interval: 30s
      timeout: 3s
      start_period: 5s
      retries: 3

  # ==========================================================
  # Caddy - Reverse Proxy & Auto HTTPS
  # ==========================================================
  caddy:
    image: caddy:latest
    container_name: courseark-caddy
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
    networks:
      - courseark-network
    depends_on:
      - web

  # ==========================================================
  # Watchtower - Auto-update containers when new images are pushed
  # ==========================================================
  watchtower:
    image: containrrr/watchtower:1.7.1
    container_name: courseark-watchtower
    restart: unless-stopped
    environment:
      # Docker API version - required for Docker 29.x compatibility
      - DOCKER_API_VERSION=1.45
      # Only update containers with the watchtower.enable=true label
      - WATCHTOWER_LABEL_ENABLE=true
      # Check for updates every 5 minutes (300 seconds)
      - WATCHTOWER_POLL_INTERVAL=300
      # Clean up old images after updating
      - WATCHTOWER_CLEANUP=true
      # Log level
      - WATCHTOWER_LOG_LEVEL=info
      # Include stopped containers
      - WATCHTOWER_INCLUDE_STOPPED=false
      # Revive stopped containers
      - WATCHTOWER_REVIVE_STOPPED=false
      # Lifecycle hooks - log updates
      - WATCHTOWER_LIFECYCLE_HOOKS=true
    volumes:
      # Docker socket for container management
      - /var/run/docker.sock:/var/run/docker.sock
      # Docker config for registry authentication (GHCR)
      # Use absolute path - defaults to /root/.docker/config.json for root user
      # Override with DOCKER_CONFIG_PATH env var if running as non-root
      - ${DOCKER_CONFIG_PATH:-/root/.docker/config.json}:/config.json:ro
    networks:
      - courseark-network

# ==========================================================
# Networks
# ==========================================================
networks:
  courseark-network:
    driver: bridge

# ==========================================================
# Volumes
# ==========================================================
volumes:
  # Named volume for SQLite database persistence
  sqlite_data:
    driver: local
  # Named volume for user-uploaded files (attachments, etc.)
  uploads_data:
    driver: local
  # Caddy data for certificates
  caddy_data:
    driver: local
  # Caddy configuration
  caddy_config:
    driver: local