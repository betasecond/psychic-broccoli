# è¯¾ç¨‹è®¨è®ºåŠŸèƒ½é—®é¢˜åˆ†æä¸ä¿®å¤æ–¹æ¡ˆ

## å‘ç°çš„é—®é¢˜

### é—®é¢˜ 1: TypeScript ç±»å‹å®šä¹‰å†²çª âš ï¸

**æ–‡ä»¶**: `frontend/src/services/discussionService.ts`

**é—®é¢˜æè¿°**:
```typescript
// ç¬¬ 4-20 è¡Œ
export interface Discussion {
  id: number
  title: string
  content?: string
  status: 'OPEN' | 'CLOSED'
  replies: number  // âŒ è¿™é‡Œæ˜¯æ•°å­—ç±»å‹ï¼ˆå›å¤æ•°é‡ï¼‰
  ...
}

// ç¬¬ 33-35 è¡Œ
export interface DiscussionDetail extends Discussion {
  replies: DiscussionReply[]  // âŒ è¿™é‡Œå˜æˆäº†æ•°ç»„ç±»å‹ï¼ˆå›å¤åˆ—è¡¨ï¼‰
}
```

**å½±å“**: TypeScript ç±»å‹å†²çªï¼Œ`replies` å­—æ®µæ—¢æ˜¯ `number` åˆæ˜¯ `DiscussionReply[]`

**ä¿®å¤æ–¹æ¡ˆ**:
```typescript
export interface Discussion {
  id: number
  title: string
  content?: string
  status: 'OPEN' | 'CLOSED'
  replyCount: number  // âœ… æ”¹åä¸º replyCount
  createdAt: string
  course?: {
    id: number
    title: string
  }
  author?: {
    id: number
    username: string
    avatarUrl?: string
  }
}

export interface DiscussionDetail extends Discussion {
  replies: DiscussionReply[]  // âœ… ç°åœ¨æ²¡æœ‰å†²çªäº†
}
```

---

### é—®é¢˜ 2: åç«¯æ•°æ®ç»“æ„ä¸ä¸€è‡´ âš ï¸

**æ–‡ä»¶**: `backend/handlers/discussions.go`

**é—®é¢˜æè¿°**:
åœ¨ `GetDiscussionDetail` å‡½æ•°ä¸­ï¼š
```go
// ç¬¬ 233 è¡Œ - å…ˆè®¾ç½® replies ä¸ºæ•°å­—
discussionData["replies"] = d.Replies  // å›å¤æ•°é‡ï¼ˆintï¼‰

// ç¬¬ 307 è¡Œ - åé¢åˆè¦†ç›–ä¸ºæ•°ç»„
discussionData["replies"] = replies  // å›å¤åˆ—è¡¨ï¼ˆ[]mapï¼‰
```

**å½±å“**: è¿”å›çš„æ•°æ®ä¸­ `replies` å­—æ®µä¸ä¸€è‡´ï¼Œå¯¼è‡´å‰ç«¯æ— æ³•æ­£ç¡®å¤„ç†

**ä¿®å¤æ–¹æ¡ˆ**:
```go
// ä¿®æ”¹ç¬¬ 233 è¡Œé™„è¿‘
discussionData := map[string]interface{}{
    "id":        d.ID,
    "title":     d.Title,
    "status":    d.Status,
    "replyCount": d.Replies,  // âœ… æ”¹ä¸º replyCount
    "createdAt": d.CreatedAt.Format(time.RFC3339),
}

// ç¬¬ 307 è¡Œä¿æŒä¸å˜
discussionData["replies"] = replies  // å›å¤åˆ—è¡¨
```

åŒæ ·éœ€è¦ä¿®æ”¹ `GetDiscussions` å‡½æ•°ï¼š
```go
// ç¬¬ 156 è¡Œ
discussionData := map[string]interface{}{
    "id":        d.ID,
    "title":     d.Title,
    "status":    d.Status,
    "replyCount": d.Replies,  // âœ… æ”¹ä¸º replyCount
    "createdAt": d.CreatedAt.Format(time.RFC3339),
}
```

---

### é—®é¢˜ 3: æ•°æ®åº“å­—æ®µå‘½åå†—ä½™

**æ–‡ä»¶**: `backend/handlers/discussions.go` ç¬¬ 70-73 è¡Œ

**é—®é¢˜æè¿°**:
```go
INSERT INTO discussions (course_id, user_id, title, content, course, author, status, replies, last_reply)
VALUES (?, ?, ?, ?, ?, ?, 'OPEN', 0, datetime('now'))
```

æ•°æ®åº“è¡¨ä¸­åŒæ—¶å­˜å‚¨äº†ï¼š
- `course_id` (å¤–é”®) å’Œ `course` (è¯¾ç¨‹å)
- `user_id` (å¤–é”®) å’Œ `author` (ç”¨æˆ·å)

**å½±å“**: æ•°æ®å†—ä½™ï¼Œä¸”è¯¾ç¨‹åæˆ–ç”¨æˆ·åå˜æ›´æ—¶éœ€è¦æ‰‹åŠ¨åŒæ­¥

**å»ºè®®**: åˆ é™¤å†—ä½™å­—æ®µï¼Œä½¿ç”¨ JOIN æŸ¥è¯¢è·å–å…³è”æ•°æ®ï¼ˆå½“å‰ä»£ç å·²ç»åœ¨ç”¨ JOINï¼Œæ‰€ä»¥è¿™äº›å†—ä½™å­—æ®µæ²¡å¿…è¦ï¼‰

---

### é—®é¢˜ 4: SQL æ—¶é—´å‡½æ•°ä¸å…¼å®¹

**æ–‡ä»¶**: `backend/handlers/discussions.go`

**é—®é¢˜æè¿°**:
```go
// ç¬¬ 72 è¡Œ
VALUES (?, ?, ?, ?, ?, ?, 'OPEN', 0, datetime('now'))

// ç¬¬ 388 è¡Œ
SET replies = replies + 1, last_reply = datetime('now')
```

ä½¿ç”¨äº† SQLite çš„ `datetime('now')`ï¼Œå¦‚æœå°†æ¥è¿ç§»åˆ°å…¶ä»–æ•°æ®åº“ï¼ˆMySQL/PostgreSQLï¼‰ä¼šä¸å…¼å®¹ã€‚

**å»ºè®®**: åœ¨ Go ä»£ç ä¸­ç”Ÿæˆæ—¶é—´æˆ³ï¼Œç¡®ä¿è·¨æ•°æ®åº“å…¼å®¹æ€§

---

## ä¿®å¤æ­¥éª¤

### æ­¥éª¤ 1: ä¿®å¤å‰ç«¯ç±»å‹å®šä¹‰

æ–‡ä»¶ï¼š`frontend/src/services/discussionService.ts`

### æ­¥éª¤ 2: ä¿®å¤åç«¯ API å“åº”

æ–‡ä»¶ï¼š`backend/handlers/discussions.go`

### æ­¥éª¤ 3: æ›´æ–°å‰ç«¯é¡µé¢ä½¿ç”¨æ–°å­—æ®µå

éœ€è¦æ£€æŸ¥å¹¶æ›´æ–°ï¼š
- `frontend/src/pages/student/DiscussionsPage.tsx`
- `frontend/src/pages/student/DiscussionDetailPage.tsx`

---

## å…¶ä»–æ½œåœ¨é—®é¢˜

### 1. ç¼ºå°‘é”™è¯¯å¤„ç†

æŸäº›æ•°æ®åº“æŸ¥è¯¢ï¼ˆå¦‚ç¬¬ 51-54 è¡Œã€ç¬¬ 64-67 è¡Œï¼‰çš„é”™è¯¯æ²¡æœ‰è¢«å¤„ç†ï¼š
```go
database.DB.QueryRow(...).Scan(&enrolled)  // æ²¡æœ‰æ£€æŸ¥é”™è¯¯
```

### 2. ç¼ºå°‘è¾“å…¥éªŒè¯

- æ ‡é¢˜å’Œå†…å®¹é•¿åº¦æ²¡æœ‰é™åˆ¶
- æ²¡æœ‰é˜²æ­¢ XSS æ”»å‡»çš„ HTML è½¬ä¹‰

### 3. æƒé™éªŒè¯å¯ä»¥ä¼˜åŒ–

é‡å¤çš„æƒé™éªŒè¯ä»£ç å¯ä»¥æå–ä¸ºè¾…åŠ©å‡½æ•°

---

## æ¨èä¿®å¤ä¼˜å…ˆçº§

1. **é«˜ä¼˜å…ˆçº§** âš ï¸
   - é—®é¢˜ 1: ç±»å‹å®šä¹‰å†²çª
   - é—®é¢˜ 2: æ•°æ®ç»“æ„ä¸ä¸€è‡´

2. **ä¸­ä¼˜å…ˆçº§** âš¡
   - ç¼ºå°‘çš„é”™è¯¯å¤„ç†
   - è¾“å…¥éªŒè¯

3. **ä½ä¼˜å…ˆçº§** ğŸ’¡
   - æ•°æ®åº“å­—æ®µå†—ä½™
   - SQL æ—¶é—´å‡½æ•°å…¼å®¹æ€§
   - ä»£ç é‡æ„ä¼˜åŒ–

---

## æµ‹è¯•å»ºè®®

ä¿®å¤åéœ€è¦æµ‹è¯•ï¼š
1. åˆ›å»ºè®¨è®º
2. æŸ¥çœ‹è®¨è®ºåˆ—è¡¨ï¼ˆéªŒè¯ replyCount æ˜¾ç¤ºæ­£ç¡®ï¼‰
3. æŸ¥çœ‹è®¨è®ºè¯¦æƒ…ï¼ˆéªŒè¯ replies æ•°ç»„æ˜¾ç¤ºæ­£ç¡®ï¼‰
4. å›å¤è®¨è®ºï¼ˆéªŒè¯å›å¤æ•°é‡æ›´æ–°ï¼‰
5. å…³é—­/åˆ é™¤è®¨è®ºï¼ˆéªŒè¯æƒé™æ§åˆ¶ï¼‰

---

ç”Ÿæˆæ—¶é—´ï¼š2026-02-08
